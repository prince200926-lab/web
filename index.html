<!DOCTYPE html>
<html>
<head>
    <title>Attendance Database</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 80%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #16a085; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .absent { background-color: #f99; }
    </style>
</head>
<body>
    <h1>Attendance Database</h1>
    <h3 id="date"></h3>
    <p>Total Students: <span id="total"></span> | Present: <span id="presentCount"></span> | Absent: <span id="absentCount"></span></p>

    <table id="attendanceTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Status</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBFLpGMhcUe3vICo_m-eyzzJkonYdQOm8E",
            authDomain: "capstone-b37ca.firebaseapp.com",
            databaseURL: "https://capstone-b37ca-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "capstone-b37ca",
            storageBucket: "capstone-b37ca.appspot.com",
            messagingSenderId: "759907486939",
            appId: "1:759907486939:web:3152ad5a0e501d452790fe"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const dateEl = document.getElementById("date");
        const tbody = document.querySelector("#attendanceTable tbody");
        const totalEl = document.getElementById("total");
        const presentEl = document.getElementById("presentCount");
        const absentEl = document.getElementById("absentCount");

        // Load student list first
        db.ref("students").once("value").then(studentSnap => {
            if (!studentSnap.exists()) {
                alert("No student list found in Firebase under 'students'");
                return;
            }

            const allStudents = Object.values(studentSnap.val()); // student names

            // Get latest attendance folder
            db.ref("attendance").once("value").then(snapshot => {
                const dates = snapshot.exists() ? Object.keys(snapshot.val()) : [];
                if (dates.length === 0) {
                    dateEl.innerText = "No attendance data available";
                    return;
                }
                const latestDate = dates.sort().reverse()[0]; // latest date
                dateEl.innerText = "Date: " + latestDate;

                const ref = db.ref("attendance/" + latestDate);
                ref.on("value", snap => {
                    const data = snap.val();
                    tbody.innerHTML = "";
                    let present = [];

                    if (data) {
                        Object.keys(data).forEach((key, index) => {
                            const row = data[key];
                            const name = row.Name || row.name || "Unknown";
                            const status = row.Status || row.status || "Present";
                            const time = row.Time || row.time || "-";
                            present.push(name.toLowerCase());

                            const tr = document.createElement("tr");
                            tr.innerHTML = `<td>${index + 1}</td>
                                            <td>${name}</td>
                                            <td>${status}</td>
                                            <td>${time}</td>`;
                            tbody.appendChild(tr);
                        });
                    }

                    // Add absent students
                    const absent = allStudents.filter(s => !present.includes(s.toLowerCase()));
                    absent.forEach((name, idx) => {
                        const tr = document.createElement("tr");
                        tr.classList.add("absent");
                        tr.innerHTML = `<td>${present.length + idx + 1}</td>
                                        <td>${name}</td>
                                        <td>Absent</td>
                                        <td>-</td>`;
                        tbody.appendChild(tr);
                    });

                    // Update counts
                    totalEl.innerText = allStudents.length;
                    presentEl.innerText = present.length;
                    absentEl.innerText = absent.length;
                });
            });
        });
    </script>
</body>
</html>
